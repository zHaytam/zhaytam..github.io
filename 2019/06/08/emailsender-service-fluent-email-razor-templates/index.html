<!DOCTYPE html>
<html lang="en-us">
<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<script type="application/ld+json">
    {
        "@context" : "http://schema.org",
        "@type" : "BlogPosting",
        "mainEntityOfPage": {
             "@type": "WebPage",
             "@id": "http:\/\/example.org\/"
        },
        "articleSection" : "post",
        "name" : "EmailSender Service using FluentEmail \x26 Razor Templates",
        "headline" : "EmailSender Service using FluentEmail \x26 Razor Templates",
        "description" : "Sending emails is a very important functionality for any website nowdays, either to send account verification emails, newsletter emails or even notification emails.\nToday I\x27ll be showing how you can create your own EmailSender Service in ASP.NET Core using FluentEmail and Razor templates for rich HTML emails.\nEmailSender interface If you\x27re working with a project that implements a Clean Architecture, you\x27ll want to create an interface in your Core project to define what you need the service to do, as well as to have the possibility to use it from the Core project too.",
        "inLanguage" : "en",
        "author" : "zHaytam",
        "creator" : "zHaytam",
        "publisher": "zHaytam",
        "accountablePerson" : "zHaytam",
        "copyrightHolder" : "zHaytam",
        "copyrightYear" : "2019",
        "datePublished": "2019-06-08 12:58:48 \x2b0000 M",
        "dateModified" : "2019-06-08 12:58:48 \x2b0000 M",
        "url" : "http:\/\/example.org\/2019\/06\/08\/emailsender-service-fluent-email-razor-templates\/",
        "wordCount" : "679",
        "image" : "http://example.org/%!s(\u003cnil\u003e)"",
        "keywords" : [ ""email"",""razor"",""sender"",""service"",""templates"","Blog" ]   
    }
    </script>


 <title>EmailSender Service using FluentEmail &amp; Razor Templates </title>


<meta name="description" content="Describe your website" />



<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="robots" content="all,follow">
<meta name="googlebot" content="index,follow,snippet,archive">
<link rel="stylesheet" id="ct-tracks-google-fonts-css" href="https://fonts.googleapis.com/css?family=Raleway%3A400%2C700&amp;subset=latin%2Clatin-ext&amp;ver=4.7.2" type="text/css" media="all">

<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css" integrity="sha384-mzrmE5qonljUremFsqc01SB46JvROS7bZs3IO2EmfFsd15uHvIt+Y8vEf7N7fWAU" crossorigin="anonymous">

<link href="http://example.org/css/style.css?v=1575894832" rel="stylesheet" id="theme-stylesheet" type='text/css' media='all'>

<link href="http://example.org/css/custom.css?v=1575894832" rel="stylesheet" type='text/css' media='all'>
<link rel="shortcut icon" href="http://example.org/img/favicon.ico" type="image/x-icon">
<link rel="icon" href="http://example.org/img/favicon.ico" type="image/x-icon">


</head>


<body class="post-template-default single single-post single-format-standard ct-body singular singular-post not-front standard">

  <div id="overflow-container" class="overflow-container">
    <a class="skip-content" href="#main">Skip to content</a>
    <header id="site-header" class="site-header" role="banner">
      <div class='top-navigation'>
        <div class='container'>

  <div id="menu-secondary" class="menu-container menu-secondary" role="navigation">
    <button id="toggle-secondary-navigation" class="toggle-secondary-navigation"><i class="fas fa-plus"></i></button>

    <div class="menu">

      <ul id="menu-secondary-items" class="menu-secondary-items">
        
        <li class="menu-item menu-item-type-taxonomy menu-item-object-category">
          <a href="/categories/algorithms">algorithms</a>
        </li>
        
        <li class="menu-item menu-item-type-taxonomy menu-item-object-category">
          <a href="/categories/asp.net-core">asp.net-core</a>
        </li>
        
        <li class="menu-item menu-item-type-taxonomy menu-item-object-category">
          <a href="/categories/c">c#</a>
        </li>
        
        <li class="menu-item menu-item-type-taxonomy menu-item-object-category">
          <a href="/categories/code-analysis">code-analysis</a>
        </li>
        
        <li class="menu-item menu-item-type-taxonomy menu-item-object-category">
          <a href="/categories/data-mining">data-mining</a>
        </li>
        
        <li class="menu-item menu-item-type-taxonomy menu-item-object-category">
          <a href="/categories/deep-learning">deep-learning</a>
        </li>
        
        <li class="menu-item menu-item-type-taxonomy menu-item-object-category">
          <a href="/categories/other">other</a>
        </li>
        
        <li class="menu-item menu-item-type-taxonomy menu-item-object-category">
          <a href="/categories/programming">programming</a>
        </li>
        
        <li class="menu-item menu-item-type-taxonomy menu-item-object-category">
          <a href="/categories/protocols">protocols</a>
        </li>
        
        <li class="menu-item menu-item-type-taxonomy menu-item-object-category">
          <a href="/categories/unity-2d/3d">unity-2d/3d</a>
        </li>
        

      </ul>

    </div>

  </div>


  <ul class="social-media-icons">


    

    

    

    

    
    <li>
      <a href="mailto:haytam.zanid@gmail.com" data-animate-hover="pulse" class="email">
        <i class="fas fa-envelope" title="email"></i>
        <span class="screen-reader-text">email</span>
      </a>
    </li>
    

    
    <li>
      <a href="https://ma.linkedin.com/in/zanid-haytam" data-animate-hover="pulse" class="linkedin" target="_blank">
        <i class="fab fa-linkedin-in" title="linkedin"></i>
        <span class="screen-reader-text">linkedin</span>
      </a>
    </li>
    

    
    <li>
      <a href="https://stackoverflow.com/users/5447084/haytam" data-animate-hover="pulse" class="stackoverflow" target="_blank">
        <i class="fab fa-stack-overflow" title="stackoverflow"></i>
        <span class="screen-reader-text">stackoverflow</span>
      </a>
    </li>
    


    
    <li>
      <a href="https://github.com/zHaytam" data-animate-hover="pulse" class="github" target="_blank">
        <i class="fab fa-github" title="github"></i>
        <span class="screen-reader-text">github</span>
      </a>
    </li>
    


    

    
    <li>
      <a href="http://example.org/index.xml" data-animate-hover="pulse" class="rss" target="_blank">
        <i class="fas fa-rss" title="rss"></i>
        <span class="screen-reader-text">rss</span>
      </a>
    </li>
    


  </ul></div>

      </div>

      <div class="container">
        <div id="title-info" class="title-info">
  <div id='site-title' class='site-title'>
    
    <a href="/"> Awaiting Bits </a>
    </div>
  </div>
  <button id="toggle-navigation" class="toggle-navigation">
    <i class="fas fa-bars"></i>
  </button>

  <div id="menu-primary-tracks" class="menu-primary-tracks"></div>
  <div id="menu-primary" class="menu-container menu-primary" role="navigation">
    
    <p class="site-description">A fast &amp; secure theme</p>
    

    <div class="menu">
      <ul id="menu-primary-items" class="menu-primary-items">
        
        
        <li class='menu-item menu-item-type-custom menu-item-object-custom '>
          <a href="http://example.org/">Home</a>
          
        </li>
        
        <li class='menu-item menu-item-type-post_type menu-item-object-page '>
          <a href="http://example.org/about/">About</a>
          
        </li>
        
        <li class='menu-item menu-item-type-post_type menu-item-object-page '>
          <a href="http://example.org/contact/">Get in touch</a>
          
        </li>
        
      </ul>
    </div>

  </div>

      </div>
    </header>

    <div id="main" class="main" role="main">

      
  
  
    
  
  
  <div id="loop-container" class="loop-container">
    

      <div class="post type-post status-publish format-standard hentry category-standard category-travel entry full-without-featured odd excerpt-1">

        
        <div class="entry-meta">
          <span class="date">08 June</span>	<span> / </span>

          <span class="author">
            <a href="http://example.org/about/" title="Posts by Zanid Haytam" rel="author">Zanid Haytam</a>
          </span>


          
          <span class="category">
            <span> / </span>

            <a href="/categories/asp.net-core">ASP.NET Core</a>
          </span>
          
          <span class="category">
            <span> / </span>

            <a href="/categories/programming">Programming</a>
          </span>
          


        </div>
        <div class='entry-header'>
          <h1 class='entry-title'> EmailSender Service using FluentEmail &amp; Razor Templates</h1>
        </div>
        <div class="entry-container">
          <div class="entry-content">
            <article>
              <p>Sending emails is a very important functionality for any website nowdays, either to send account verification emails, newsletter emails or even notification emails.<br>
Today I'll be showing how you can create your own EmailSender Service in ASP.NET Core using FluentEmail and Razor templates for rich HTML emails.</p>
<h2 id="emailsender-interface">EmailSender interface</h2>
<p>If you're working with a project that implements a Clean Architecture, you'll want to create an interface in your Core project to define what you need the service to do, as well as to have the possibility to use it from the Core project too.</p>
<pre><code>public interface IEmailSender
{

    Task&lt;bool&gt; SendUsingTemplate(string to, string subject, EmailTemplate template, object model);

}
</code></pre><p>The method `SendUsingTemplate` has the following signature:</p>
<ul>
<li><code>Task&lt;bool&gt;</code>, the method is async and will return true if the email was successfully sent or false otherwise.</li>
<li><code>string to</code>, the recipient email address.</li>
<li><code>string subject</code>, the email's subject/title.</li>
<li><code>EmailTemplate template</code>, which template to use (enum).</li>
<li><code>object model</code>, since most of the time you'll want to send more information in the email, you can pass a model (or an anonymous object) to the template.</li>
</ul>
<!-- raw HTML omitted -->
<p>If you noticed, the method doesn't require a `from` email address, that's because we'll configure it in our `Startup` class since we usually only use one.</p>
<pre><code>public enum EmailTemplate
{
    EmailConfirmation,
    ChangeEmail
}
</code></pre><p>I use an enum for the template names to remove the chance of someone getting the template's name wrong. Magic strings are always a bad idea.</p>
<h2 id="emailsender-implementation">EmailSender Implementation</h2>
<h3 id="prerequesites">Prerequesites</h3>
<p>For the implementation of the service, you'll only need the `FluentEmail.Core` NuGet package: `Install-Package FluentEmail.Core`</p>
<h3 id="implementation">Implementation</h3>
<pre><code>public class EmailSender : IEmailSender
{

    private const string TemplatePath = &quot;Web.Api.Infrastructure.Services.Emails.Templates.{0}.cshtml&quot;;
    private readonly IFluentEmail _email;
    private readonly ILogger&lt;EmailSender&gt; _logger;

    public EmailSender(IFluentEmail email, ILogger&lt;EmailSender&gt; logger)
    {
        _email = email;
        _logger = logger;
    }

    public async Task&lt;bool&gt; SendUsingTemplate(string to, string subject, EmailTemplate template, object model)
    {
        var result = await _email.To(to)
            .Subject(subject)
            .UsingTemplateFromEmbedded(string.Format(TemplatePath, template), ToExpando(model), GetType().Assembly)
            .SendAsync();

        if (!result.Successful)
        {
            _logger.LogError(&quot;Failed to send an email.\n{Errors}&quot;, string.Join(Environment.NewLine, result.ErrorMessages));
        }

        return result.Successful;
    }

}
</code></pre><p>The code is pretty straight-forward, we use FluentEmail's `IFluentEmail` object (that gets injected) to send the email asynchronously.<br>
I often prefer to log the errors in the service and only return a boolean response.<br>
I don't think the client needs to know why the email wasn't sent, the developpers need to deal with that.</p>
<p>The only thing you'll need to change is the `TemplatePath` constant, which needs to contain the full namespace name where your template files (.cshtml files) reside.</p>
<p>In order to be able to use anonymous objects in the templates, we'll need to convert them into <!-- raw HTML omitted -->Expando objects<!-- raw HTML omitted -->. This is a “limitation” that <!-- raw HTML omitted -->RazorLight <!-- raw HTML omitted -->(the library that FluentEmail uses to handle Razor Templates) has.</p>
<pre><code>private static ExpandoObject ToExpando(object model)
{
    if (model is ExpandoObject exp)
    {
        return exp;
    }

    IDictionary&lt;string, object&gt; expando = new ExpandoObject();
    foreach (var propertyDescriptor in model.GetType().GetTypeInfo().GetProperties())
    {
        var obj = propertyDescriptor.GetValue(model);

        if (obj != null &amp;&amp; IsAnonymousType(obj.GetType()))
        {
            obj = ToExpando(obj);
        }

        expando.Add(propertyDescriptor.Name, obj);
    }

    return (ExpandoObject)expando;
}

private static bool IsAnonymousType(Type type)
{
    bool hasCompilerGeneratedAttribute = type.GetTypeInfo()
        .GetCustomAttributes(typeof(CompilerGeneratedAttribute), false)
        .Any();

    bool nameContainsAnonymousType = type.FullName.Contains(&quot;AnonymousType&quot;);
    bool isAnonymousType = hasCompilerGeneratedAttribute &amp;&amp; nameContainsAnonymousType;

    return isAnonymousType;
}
</code></pre><p>The code might look alien but all it does is convert every anonymous object to an Expando object recursively (since anonymous objects can have anonymous objects…).</p>
<h2 id="razor-templates">Razor Templates</h2>
<p>Based on your `TemplatePath` value, you will need to put all your cshtml template files in that folder and they must be marked as: <strong>Embedded resource</strong>.</p>
<p>For example, this my ChangeEmail template file:</p>
<!-- raw HTML omitted -->
<h2 id="configuration">Configuration</h2>
<h3 id="prerequesites1">Prerequesites</h3>
<p>When configuring the EmailSender service, you'll need the following NuGet packages:</p>
<ul>
<li>FluentEmail.Smtp</li>
<li>FluentEmail.Razor</li>
</ul>
<h3 id="services">Services</h3>
<pre><code>// Configure IFluentEmail
services.AddFluentEmail(Configuration[&quot;email_address&quot;])
.AddRazorRenderer()
.AddSmtpSender(new SmtpClient(&quot;smtp.gmail.com&quot;, 587)
{
    Credentials = new NetworkCredential(Configuration[&quot;email_address&quot;], Configuration[&quot;email_password&quot;]),
    EnableSsl = true
});

// Add our service
services.TryAddScoped&lt;IEmailSender, EmailSender&gt;();
</code></pre><p>In this example I'm using a GMAIL account to send the emails, you can use whatever email server you want, even your own.</p>
<h2 id="conclusion">Conclusion</h2>
<p>As you can see, creating an EmailSender service is pretty easy and straight-forward and can be used in all your projects. Having the ability to send rich HTML emails is a must for every website nowdays.</p>

            </article>
          </div>
          
      <div class='entry-meta-bottom'>
        

  <div class="entry-categories"><p><span>Categories</span>
    
    <a href="/categories/asp.net-core" title="View all posts in ASP.NET Core">ASP.NET Core</a>
    <a href="/categories/programming" title="View all posts in Programming">Programming</a>
  </p>
</div>



<div class="entry-tags"><p><span>Tags</span>
  
  <a href="/tags/email" title="View all posts tagged email">email</a>
  
  <a href="/tags/razor" title="View all posts tagged razor">razor</a>
  
  <a href="/tags/sender" title="View all posts tagged sender">sender</a>
  
  <a href="/tags/service" title="View all posts tagged service">service</a>
  
  <a href="/tags/templates" title="View all posts tagged templates">templates</a>
  

</p></div>	</div>

	
<div class="author-meta">

  <div class="author">
    	
      <img alt='Zanid Haytam' src="https://www.gravatar.com/avatar/3b94119ba495ae8d2328fc0b2bb0825a?s=100&d=identicon" class='avatar avatar-72 photo' height='72' width='72'>
    
    <span>
      Written by:<a href="http://example.org/about/" title="Posts by Zanid Haytam" rel="author">Zanid Haytam</a> </span>
    </div>
    <div class="bio">
      
      
      <p>Zanid Haytam is an enthusiastic programmer that enjoys coding, reading code, hunting bugs and writing blog posts.</p>
      
      
	







<a class="linkedin" target="_blank"
href="https://ma.linkedin.com/in/zanid-haytam">
<i class="fab fa-linkedin"
title="linkedin icon"></i>
</a>



<a class="email" target="_blank"
href="mailto:haytam.zanid@gmail.com">
<i class="fas fa-envelope"
title="email icon"></i>
</a>





<a class="stackoverflow" target="_blank"
href="https://stackoverflow.com/users/5447084/haytam">
<i class="fab fa-stack-overflow"
title="stackoverflow icon"></i>
</a>



<a class="github" target="_blank"
href="https://github.com/zHaytam">
<i class="fab fa-github"
title="github icon"></i>
</a>







</div>
</div>

</div>
</div>

<section id="comments" class="comments">
  

  




</section>
</div>

 



    </div>

    <footer id="site-footer" class="site-footer" role="contentinfo">
	<h1>
    
    <a href=""> Awaiting Bits </a>
    
	</h1>

			
			<p class="site-description">A fast &amp; secure theme</p>
			

		<div id="menu-footer" class="menu-container menu-footer" role="navigation">
		<div class="menu">

      <ul id="menu-footer-items" class="menu-footer-items">
        
</ul>

</div>	</div>

<ul class="social-media-icons">

        

        


        

        

        
        <li>
        <a href="mailto:haytam.zanid@gmail.com"  class="email">
            <i class="fas fa-envelope" title="email"></i>
            <span class="screen-reader-text">email</span>
        </a>
        </li>
        

        
        <li>
        <a href="https://ma.linkedin.com/in/zanid-haytam" class="linkedin" target="_blank">
            <i class="fab fa-linkedin-in" title="linkedin"></i>
            <span class="screen-reader-text">linkedin</span>
        </a>
        </li>
        

        
        <li>
        <a href="https://stackoverflow.com/users/5447084/haytam"  class="stackoverflow" target="_blank">
            <i class="fab fa-stack-overflow" title="stackoverflow"></i>
            <span class="screen-reader-text">stackoverflow</span>
        </a>
        </li>
        


        
        <li>
        <a href="https://github.com/zHaytam"  class="github" target="_blank">
            <i class="fab fa-github" title="github"></i>
            <span class="screen-reader-text">github</span>
        </a>
        </li>
        


        

        
        <li>
        <a href="http://example.org/index.xml" data-animate-hover="pulse" class="rss" target="_blank">
            <i class="fas fa-rss" title="rss"></i>
            <span class="screen-reader-text">rss</span>
        </a>
        </li>
        

				</ul>	<div class="design-credit">
		
		<p>© 2019 Zanid Haytam</p>
		
		<p>Nederburg Hugo Theme by <a href="https://appernetic.io">Appernetic</a>.</p>
		
		<p>A port of Tracks by Compete Themes.</p>
		
	</div>
</footer>

  </div>
  <script src="http://example.org/js/jquery.min.js"></script>
<script src="http://example.org/js/jquerymigrate.js"></script>
<script src="http://example.org/js/production.min.js?v=1575894832"></script>

</body>
</html>
