<!DOCTYPE html>
<html lang="en-us">
<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<script type="application/ld+json">
    {
        "@context" : "http://schema.org",
        "@type" : "BlogPosting",
        "mainEntityOfPage": {
             "@type": "WebPage",
             "@id": "http:\/\/example.org\/"
        },
        "articleSection" : "post",
        "name" : "Outliers Detection in PySpark #2 – Interquartile Range",
        "headline" : "Outliers Detection in PySpark #2 – Interquartile Range",
        "description" : "In the first part, I talked about what Data Quality, Anomaly Detection and Outliers Detection are and what’s the difference between outliers detection and novelty detection.\nIn this part, I will talk about a very known and easy method to detect outliers called Interquartile Range.\nIntroduction The Interquartile Range method, also known as IQR, was developed by John Widler Turky, an American mathematician best known for development of the FFT algorithm and box plot.",
        "inLanguage" : "en",
        "author" : "zHaytam",
        "creator" : "zHaytam",
        "publisher": "zHaytam",
        "accountablePerson" : "zHaytam",
        "copyrightHolder" : "zHaytam",
        "copyrightYear" : "2019",
        "datePublished": "2019-07-15 13:31:51 \x2b0000 \x2b0000",
        "dateModified" : "2019-07-15 13:31:51 \x2b0000 \x2b0000",
        "url" : "http:\/\/example.org\/2019\/07\/15\/outliers-detection-in-pyspark-2-interquartile-range\/",
        "wordCount" : "416",
        "image" : "http://example.org/%!s(\u003cnil\u003e)"",
        "keywords" : [ ""boxplot"",""iqr"",""outliers detection"","Blog" ]   
    }
    </script>


 <title>Outliers Detection in PySpark #2 – Interquartile Range </title>


<meta name="description" content="Describe your website" />



<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="robots" content="all,follow">
<meta name="googlebot" content="index,follow,snippet,archive">
<link rel="stylesheet" id="ct-tracks-google-fonts-css" href="https://fonts.googleapis.com/css?family=Raleway%3A400%2C700&amp;subset=latin%2Clatin-ext&amp;ver=4.7.2" type="text/css" media="all">

<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css" integrity="sha384-mzrmE5qonljUremFsqc01SB46JvROS7bZs3IO2EmfFsd15uHvIt+Y8vEf7N7fWAU" crossorigin="anonymous">

<link href="http://example.org/css/style.css?v=1575894832" rel="stylesheet" id="theme-stylesheet" type='text/css' media='all'>

<link href="http://example.org/css/custom.css?v=1575894832" rel="stylesheet" type='text/css' media='all'>
<link rel="shortcut icon" href="http://example.org/img/favicon.ico" type="image/x-icon">
<link rel="icon" href="http://example.org/img/favicon.ico" type="image/x-icon">


</head>


<body class="post-template-default single single-post single-format-standard ct-body singular singular-post not-front standard">

  <div id="overflow-container" class="overflow-container">
    <a class="skip-content" href="#main">Skip to content</a>
    <header id="site-header" class="site-header" role="banner">
      <div class='top-navigation'>
        <div class='container'>

  <div id="menu-secondary" class="menu-container menu-secondary" role="navigation">
    <button id="toggle-secondary-navigation" class="toggle-secondary-navigation"><i class="fas fa-plus"></i></button>

    <div class="menu">

      <ul id="menu-secondary-items" class="menu-secondary-items">
        
        <li class="menu-item menu-item-type-taxonomy menu-item-object-category">
          <a href="/categories/algorithms">algorithms</a>
        </li>
        
        <li class="menu-item menu-item-type-taxonomy menu-item-object-category">
          <a href="/categories/asp.net-core">asp.net-core</a>
        </li>
        
        <li class="menu-item menu-item-type-taxonomy menu-item-object-category">
          <a href="/categories/c">c#</a>
        </li>
        
        <li class="menu-item menu-item-type-taxonomy menu-item-object-category">
          <a href="/categories/code-analysis">code-analysis</a>
        </li>
        
        <li class="menu-item menu-item-type-taxonomy menu-item-object-category">
          <a href="/categories/data-mining">data-mining</a>
        </li>
        
        <li class="menu-item menu-item-type-taxonomy menu-item-object-category">
          <a href="/categories/deep-learning">deep-learning</a>
        </li>
        
        <li class="menu-item menu-item-type-taxonomy menu-item-object-category">
          <a href="/categories/other">other</a>
        </li>
        
        <li class="menu-item menu-item-type-taxonomy menu-item-object-category">
          <a href="/categories/programming">programming</a>
        </li>
        
        <li class="menu-item menu-item-type-taxonomy menu-item-object-category">
          <a href="/categories/protocols">protocols</a>
        </li>
        
        <li class="menu-item menu-item-type-taxonomy menu-item-object-category">
          <a href="/categories/unity-2d/3d">unity-2d/3d</a>
        </li>
        

      </ul>

    </div>

  </div>


  <ul class="social-media-icons">


    

    

    

    

    
    <li>
      <a href="mailto:haytam.zanid@gmail.com" data-animate-hover="pulse" class="email">
        <i class="fas fa-envelope" title="email"></i>
        <span class="screen-reader-text">email</span>
      </a>
    </li>
    

    
    <li>
      <a href="https://ma.linkedin.com/in/zanid-haytam" data-animate-hover="pulse" class="linkedin" target="_blank">
        <i class="fab fa-linkedin-in" title="linkedin"></i>
        <span class="screen-reader-text">linkedin</span>
      </a>
    </li>
    

    
    <li>
      <a href="https://stackoverflow.com/users/5447084/haytam" data-animate-hover="pulse" class="stackoverflow" target="_blank">
        <i class="fab fa-stack-overflow" title="stackoverflow"></i>
        <span class="screen-reader-text">stackoverflow</span>
      </a>
    </li>
    


    
    <li>
      <a href="https://github.com/zHaytam" data-animate-hover="pulse" class="github" target="_blank">
        <i class="fab fa-github" title="github"></i>
        <span class="screen-reader-text">github</span>
      </a>
    </li>
    


    

    
    <li>
      <a href="http://example.org/index.xml" data-animate-hover="pulse" class="rss" target="_blank">
        <i class="fas fa-rss" title="rss"></i>
        <span class="screen-reader-text">rss</span>
      </a>
    </li>
    


  </ul></div>

      </div>

      <div class="container">
        <div id="title-info" class="title-info">
  <div id='site-title' class='site-title'>
    
    <a href="/"> Awaiting Bits </a>
    </div>
  </div>
  <button id="toggle-navigation" class="toggle-navigation">
    <i class="fas fa-bars"></i>
  </button>

  <div id="menu-primary-tracks" class="menu-primary-tracks"></div>
  <div id="menu-primary" class="menu-container menu-primary" role="navigation">
    
    <p class="site-description">A fast &amp; secure theme</p>
    

    <div class="menu">
      <ul id="menu-primary-items" class="menu-primary-items">
        
        
        <li class='menu-item menu-item-type-custom menu-item-object-custom '>
          <a href="http://example.org/">Home</a>
          
        </li>
        
        <li class='menu-item menu-item-type-post_type menu-item-object-page '>
          <a href="http://example.org/about/">About</a>
          
        </li>
        
        <li class='menu-item menu-item-type-post_type menu-item-object-page '>
          <a href="http://example.org/contact/">Get in touch</a>
          
        </li>
        
      </ul>
    </div>

  </div>

      </div>
    </header>

    <div id="main" class="main" role="main">

      
  
  
    
  
  
  <div id="loop-container" class="loop-container">
    

      <div class="post type-post status-publish format-standard hentry category-standard category-travel entry full-without-featured odd excerpt-1">

        
        <div class="entry-meta">
          <span class="date">15 July</span>	<span> / </span>

          <span class="author">
            <a href="http://example.org/about/" title="Posts by Zanid Haytam" rel="author">Zanid Haytam</a>
          </span>


          
          <span class="category">
            <span> / </span>

            <a href="/categories/algorithms">Algorithms</a>
          </span>
          
          <span class="category">
            <span> / </span>

            <a href="/categories/data-mining">Data Mining</a>
          </span>
          


        </div>
        <div class='entry-header'>
          <h1 class='entry-title'> Outliers Detection in PySpark #2 – Interquartile Range</h1>
        </div>
        <div class="entry-container">
          <div class="entry-content">
            <article>
              <p>In the <!-- raw HTML omitted -->first part<!-- raw HTML omitted -->, I talked about what Data Quality, Anomaly Detection and Outliers Detection are and what’s the difference between outliers detection and novelty detection.<br>
In this part, I will talk about a very known and easy method to detect outliers called Interquartile Range.</p>
<h2 id="introduction">Introduction</h2>
<p>The Interquartile Range method, also known as IQR, was developed by John Widler Turky, an American mathematician best known for development of the FFT algorithm and box plot.</p>
<p>IQR is a measure of statistical dispersion, which is equal to the difference between the 75th <!-- raw HTML omitted -->percentile <!-- raw HTML omitted -->and the 25th <!-- raw HTML omitted -->percentile<!-- raw HTML omitted -->.<br>
In other words:</p>
<!-- raw HTML omitted -->
<h2 id="how-interquartile-range-worksfigure-classwpblockimage">How Interquartile Range works<!-- raw HTML omitted --></h2>
<p><!-- raw HTML omitted --><!-- raw HTML omitted -->Representation of the Interquartile Range - Wikipedia<!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<p>IQR is a fairly interpretable method, often used to draw Box Plots and display the distribution of a dataset.</p>
<p>IQR Can also be used to detect outliers in a few easy and straightforward steps:</p>
<ol>
<li>Calculate the 1st quartile <!-- raw HTML omitted -->.</li>
<li>Calculate the 3rd quartile <!-- raw HTML omitted -->.</li>
<li>Calculate <!-- raw HTML omitted -->.</li>
<li>Calculate the bounds:
<ol>
<li>Lower bound: <!-- raw HTML omitted --></li>
<li>Upper bound: <!-- raw HTML omitted --></li>
</ol>
</li>
<li>Flag any points outside the bounds as suspected outliers.</li>
</ol>
<p>If you're wondering why John chose  <!-- raw HTML omitted -->and not some other value, it can be explained in the Wikipedia picture and also this <!-- raw HTML omitted -->post<!-- raw HTML omitted -->.</p>
<p>If we look at the picture, we can see that the lower bound and the upper bound correspond, respectively, to  <!-- raw HTML omitted -->and <!-- raw HTML omitted -->.<br>
This reminds me of the `68-95-99.7 rule`, which says that about 99.7% of points are within  <!-- raw HTML omitted -->and that the rest can be considered as outliers.</p>
<h2 id="pyspark-implementation">PySpark Implementation</h2>
<p>This PySpark implementation can work on any <code>Dataframe</code> and all of its columns. The Dataframe should have a unique column used to identify outliers.</p>
<h3 id="imports">Imports</h3>
<pre><code>import pyspark.sql.functions as f
</code></pre><h3 id="calculating-the-bounds">Calculating the bounds</h3>
<p>Firstly, we calculate the lower and upper bounds for each column:</p>
<pre><code>def calculate_bounds(df):
	bounds = {
        c: dict(
            zip([&quot;q1&quot;, &quot;q3&quot;], df.approxQuantile(c, [0.25, 0.75], 0))
        )
        for c,d in zip(df.columns, df.dtypes) if d[1] == &quot;int&quot;
    }

    for c in bounds:
        iqr = bounds[c]['q3'] - bounds[c]['q1']
        bounds[c]['min'] = bounds[c]['q1'] - (iqr * 1.5)
        bounds[c]['max'] = bounds[c]['q3'] + (iqr * 1.5)

    return bounds
</code></pre><h3 id="flagging-outliers">Flagging outliers</h3>
<p>Then we flag outliers based on the calculated bounds. For each column, we create a new column named <code>columnName_outlier</code> that contains `yes` or `no`.</p>
<pre><code>def flag_outliers(df, id_col):
	bounds = calculate_bounds(df)
	outliers = {}

	return df.select(c, id_col,
        *[
            f.when(
                ~f.col(c).between(bounds[c]['min'], bounds[c]['max']),
                &quot;yes&quot;
            ).otherwise(&quot;no&quot;).alias(c+'_outlier')
        ]
    )
</code></pre><h2 id="conclusion">Conclusion</h2>
<p>To sum up, IQR or Interquartile Range is a very interpretable method to detect outliers. In this blog post, I explained how the method works and showed how we can easily implement it in PySpark.</p>

            </article>
          </div>
          
      <div class='entry-meta-bottom'>
        

  <div class="entry-categories"><p><span>Categories</span>
    
    <a href="/categories/algorithms" title="View all posts in Algorithms">Algorithms</a>
    <a href="/categories/data-mining" title="View all posts in Data Mining">Data Mining</a>
  </p>
</div>



<div class="entry-tags"><p><span>Tags</span>
  
  <a href="/tags/boxplot" title="View all posts tagged boxplot">boxplot</a>
  
  <a href="/tags/iqr" title="View all posts tagged iqr">iqr</a>
  
  <a href="/tags/outliers-detection" title="View all posts tagged outliers detection">outliers detection</a>
  

</p></div>	</div>

	
<div class="author-meta">

  <div class="author">
    	
      <img alt='Zanid Haytam' src="https://www.gravatar.com/avatar/3b94119ba495ae8d2328fc0b2bb0825a?s=100&d=identicon" class='avatar avatar-72 photo' height='72' width='72'>
    
    <span>
      Written by:<a href="http://example.org/about/" title="Posts by Zanid Haytam" rel="author">Zanid Haytam</a> </span>
    </div>
    <div class="bio">
      
      
      <p>Zanid Haytam is an enthusiastic programmer that enjoys coding, reading code, hunting bugs and writing blog posts.</p>
      
      
	







<a class="linkedin" target="_blank"
href="https://ma.linkedin.com/in/zanid-haytam">
<i class="fab fa-linkedin"
title="linkedin icon"></i>
</a>



<a class="email" target="_blank"
href="mailto:haytam.zanid@gmail.com">
<i class="fas fa-envelope"
title="email icon"></i>
</a>





<a class="stackoverflow" target="_blank"
href="https://stackoverflow.com/users/5447084/haytam">
<i class="fab fa-stack-overflow"
title="stackoverflow icon"></i>
</a>



<a class="github" target="_blank"
href="https://github.com/zHaytam">
<i class="fab fa-github"
title="github icon"></i>
</a>







</div>
</div>

</div>
</div>

<section id="comments" class="comments">
  

  




</section>
</div>

 



    </div>

    <footer id="site-footer" class="site-footer" role="contentinfo">
	<h1>
    
    <a href=""> Awaiting Bits </a>
    
	</h1>

			
			<p class="site-description">A fast &amp; secure theme</p>
			

		<div id="menu-footer" class="menu-container menu-footer" role="navigation">
		<div class="menu">

      <ul id="menu-footer-items" class="menu-footer-items">
        
</ul>

</div>	</div>

<ul class="social-media-icons">

        

        


        

        

        
        <li>
        <a href="mailto:haytam.zanid@gmail.com"  class="email">
            <i class="fas fa-envelope" title="email"></i>
            <span class="screen-reader-text">email</span>
        </a>
        </li>
        

        
        <li>
        <a href="https://ma.linkedin.com/in/zanid-haytam" class="linkedin" target="_blank">
            <i class="fab fa-linkedin-in" title="linkedin"></i>
            <span class="screen-reader-text">linkedin</span>
        </a>
        </li>
        

        
        <li>
        <a href="https://stackoverflow.com/users/5447084/haytam"  class="stackoverflow" target="_blank">
            <i class="fab fa-stack-overflow" title="stackoverflow"></i>
            <span class="screen-reader-text">stackoverflow</span>
        </a>
        </li>
        


        
        <li>
        <a href="https://github.com/zHaytam"  class="github" target="_blank">
            <i class="fab fa-github" title="github"></i>
            <span class="screen-reader-text">github</span>
        </a>
        </li>
        


        

        
        <li>
        <a href="http://example.org/index.xml" data-animate-hover="pulse" class="rss" target="_blank">
            <i class="fas fa-rss" title="rss"></i>
            <span class="screen-reader-text">rss</span>
        </a>
        </li>
        

				</ul>	<div class="design-credit">
		
		<p>© 2019 Zanid Haytam</p>
		
		<p>Nederburg Hugo Theme by <a href="https://appernetic.io">Appernetic</a>.</p>
		
		<p>A port of Tracks by Compete Themes.</p>
		
	</div>
</footer>

  </div>
  <script src="http://example.org/js/jquery.min.js"></script>
<script src="http://example.org/js/jquerymigrate.js"></script>
<script src="http://example.org/js/production.min.js?v=1575894832"></script>

</body>
</html>
